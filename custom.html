<script type="text/javascript">
    RED.nodes.registerType('custom-output',{
        category: 'hapcan',
        color: '#C1C1C1',
        defaults: {
            gateway: {type:"hapcan-gateway", required: true},
            name: {value:""},
            group: {value: 240, required: true, validate: function(val){return (val > 0 && val < 256);} },
            node: {value: 240, required: true, validate: function(val){return (val > 0 && val < 256);}},
            frameType: {value: 266, required: true, validate: function(val) {if(!Number.isInteger(val)) return false; if(Number(val)<0 || Number(val)> 4095) return false; return true;} },
            d0name: {value:''},
            d1name: {value:''},
            d2name: {value:''},
            d3name: {value:''},
            d4name: {value:''},
            d5name: {value:''},
            d6name: {value:''},
            d7name: {value:''},
            d0value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d1value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d2value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d3value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d4value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d5value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d6value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
            d7value: {value: 255, validate: function(val){ var num = Number(val); if( !Number.isInteger(num)) return false; return (num>=0 && num <= 255)}},
        },
        inputs:1,
        outputs:0,
        icon: "relay-output.png",
        align: 'right',
        label: function() {
            
            return (this.name||"custom output") + ' ('+this.node+','+this.group+')';
        },
        labelStyle: function() { return this.name?"node_label_italic":""; } ,
        inputLabels: "custom control",
        oneditprepare: function() {
            var nodeOptions = '';
            var groupOptions = '';
            for(var i = 1; i < 256; i++)
            {
                var selectedNode = '';
                if((Number(this.node) === i))
                    selectedNode = 'selected="selected"';
                nodeOptions += '<option '+ selectedNode +' value="'+i+'">'+i+'</option>';

                var selectedGroup = '';
                if((Number(this.group) === i))
                    selectedGroup = 'selected="selected"';
                
                groupOptions += '<option '+ selectedGroup +' value="'+i+'">'+i+'</option>';
            }
            
            $("#node-input-node").append(nodeOptions).on("change", function(){computePreview()});
            $("#node-input-group").append(groupOptions).on("change", function(){computePreview()});

            $('#frame-type').val( ('000'+ Number(this.frameType).toString(16)).substr(-3));
            updateFrameTypeName()

            function computePreview(){
                $('table.frame-preview td').each(function(i){
                    
                    switch(i)
                    {
                        case 1: $(this).text( $('#frame-type').val().substr(0,2) ); break;
                        case 2: $(this).text( $('#frame-type').val().substr(-1)+'0' ); break;
                        case 3: $(this).text(('00'+Number($('#node-input-node').val()).toString(16)).substr(-2));break
                        case 4: $(this).text(('00'+Number($('#node-input-group').val()).toString(16)).substr(-2));break
                        case 5: $(this).text($('#d0hex').val()); break;
                        case 6: $(this).text($('#d1hex').val()); break;
                        case 7: $(this).text($('#d2hex').val()); break;
                        case 8: $(this).text($('#d3hex').val()); break;
                        case 9: $(this).text($('#d4hex').val()); break;
                        case 10: $(this).text($('#d5hex').val()); break;
                        case 11: $(this).text($('#d6hex').val()); break;
                        case 12: $(this).text($('#d7hex').val()); break;
                    }
                })

                var sum = 0;
                for (var i = 2; i < 14; i++)
                {
                    sum += parseInt($('table.frame-preview td:nth-child('+i+')').text(), 16)
                }

                $('table.frame-preview td:nth-child(14)').text(('00'+sum.toString(16)).substr(-2))
            }

            function updateFrameTypeName(){
                var val = $('#frame-type').val()

                var frameName = 'custom frame'
                switch(val.toUpperCase()){
                    case '010': frameName = 'all exit from programming mode'; break
                    case '020': frameName = 'node exit from programming mode'; break
                    case '030': frameName = 'programming address frame'; break
                    case '040': frameName = 'programming data frame'; break
                    case '0F0': frameName = 'error frame'; break
                    case '101': frameName = 'reset group request'; break
                    case '102': frameName = 'reset node request'; break
                    case '103': frameName = 'group serial numbers request'; break
                    case '104': frameName = 'node serial number request'; break
                    case '105': frameName = 'group firmware request'; break
                    case '106': frameName = 'node firmware request'; break
                    case '107': frameName = 'set node default ID'; break
                    case '108': frameName = 'group status request'; break
                    case '109': frameName = 'node status request'; break
                    case '10A': frameName = 'execute node instruction'; break
                    case '10B': frameName = 'group power supply voltage request'; break
                    case '10C': frameName = 'node power supply voltage request'; break
                    case '10D': frameName = 'group description request'; break
                    case '10E': frameName = 'node description request'; break
                    case '10F': frameName = 'group processor ID request'; break
                    case '111': frameName = 'node processor ID request'; break
                    case '112': frameName = 'group uptime request'; break
                    case '113': frameName = 'node uptime request'; break
                    case '114': frameName = 'group health check request'; break
                    case '115': frameName = 'node health check request'; break

                    case '300': frameName = 'real time clock status'; break
                    case '301': frameName = 'button status'; break
                    case '302': frameName = 'relay status'; break
                    case '303': frameName = 'ir receiver status'; break
                    case '304': frameName = 'temperature status'; break
                    case '306': frameName = 'dimmer status'; break
                    case '307': frameName = 'blind controller status'; break
                    case '308': frameName = 'RGB LED controller status'; break
                    case '309': frameName = 'open collector output status'; break
                }
                $('#frame-type-name').text(frameName)
            }
            
            $('.property-value-hex').each(function(){
                $(this).keypress(function(event) {
                    var regex = new RegExp("^[a-fA-F0-9]+$");
                    var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
                    if (!regex.test(key)) {
                        event.preventDefault();
                        return false;
                    }
                })
                $(this).on("change paste keyup", function(){
                    $(this).next().val(parseInt($(this).val(), 16))

                    updateFrameTypeName()
                    computePreview();
                })

                $(this).on("change", function(){
                    var max = Number($(this).attr('maxlength'))
                    var val = ('000' + $(this).val()).substr(-1*max) 
                    $(this).val(val)

                    updateFrameTypeName()
                    computePreview();
                })                
            })

            
            $('.databytes .property-value-dec').each(function(){
                $(this).on("change paste keyup", function(){
                    if(Number($(this).val()) < 0 )
                        $(this).val('0')
                    if(Number($(this).val()) > 255 )
                        $(this).val('255')
                    $(this).prev().val(('00'+Number(($(this).val())).toString(16)).substr(-2))

                    computePreview();
                })                
                $(this).keypress(function(event) {
                    var regex = new RegExp("^[0-9]+$");
                    var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
                    if (!regex.test(key)) {
                        event.preventDefault();
                        return false;
                    }
                })
            })
        },
        oneditsave: function(){
            this.frameType = parseInt($('#frame-type').val(), 16);
        }
        });
</script>

<script type="text/x-red" data-template-name="custom-output">
    <style>
        .databytes .property-name {
            width: 23%;
        }
        .databytes .property-value-hex {
            width: 40px;
            text-transform:uppercase;
        }

        #frame-type {
            width: 50px;
            text-transform:uppercase;
        }
     
        .databytes .property-value-dec {
            width: 50px;
        }
        table.frame-preview {
            width: 100%;
            background-color: #bbb;
            border-spacing: 2px;
            border-collapse: separate;
            text-align: center;
        }
        .frame-preview td {
            padding: 4px 2px;
            background-color: #eee;
            width: 6%;
            text-transform:uppercase;
        }
        .frame-preview td.const {
            background-color: #ddd;
        }
        .frame-preview td.data {
            background-color: #fafafa;
        }

    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Device name">
    </div>
    <div class="form-row">
        <label for="node-input-gateway"><i class="fa fa-globe"></i> Gateway</label>
        <input type="text" id="node-input-gateway" placeholder="Gateway">
    </div>
    <div class="form-row">
        <label for="node-input-node"><i class="fa fa-microchip"></i> Comp node</label>
        <select id="node-input-node"></select>
    </div>
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-th"></i> Comp group</label>
        <select id="node-input-group"></select>
    </div>

    <hr>

    <div class="form-row">
        <label for="frameType"><i class="fa fa-sign-out"></i> Frame type</label>
        <input class="property-value-hex" type="text" maxlength="3" id="frame-type" placeholder="HEX">
        <span id="frame-type-name">custom frame</span>
    </div>

    <div class="databytes">
        <div class="form-row">
            <label for="node-input-d0name"><i class="fa fa-cube"></i> D0</label>
            <input class="property-name" type="text" id="node-input-d0name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d0hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d0value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d1name"><i class="fa fa-cube"></i> D1</label>
            <input  class="property-name" type="text" id="node-input-d1name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d1hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d1value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d2name"><i class="fa fa-cube"></i> D2</label>
            <input class="property-name" type="text" id="node-input-d2name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d2hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d2value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d3name"><i class="fa fa-cube"></i> D3</label>
            <input class="property-name" type="text" id="node-input-d3name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d3hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d3value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d4name"><i class="fa fa-cube"></i> D4</label>
            <input class="property-name" type="text" id="node-input-d4name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d4hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d4value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d5name"><i class="fa fa-cube"></i> D5</label>
            <input class="property-name" type="text" id="node-input-d5name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d5hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d5value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d6name"><i class="fa fa-cube"></i> D6</label>
            <input class="property-name" type="text" id="node-input-d6name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d6hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d6value" placeholder="dec">
        </div>
        <div class="form-row">
            <label for="node-input-d7name"><i class="fa fa-cube"></i> D7</label>
            <input class="property-name" type="text" id="node-input-d7name" placeholder="property name">
            <input class="property-value-hex" type="text" maxlength="2" id="d7hex" placeholder="hex">
            <input class="property-value-dec" type="text" maxlength="3" id="node-input-d7value" placeholder="dec">
        </div>
    </div>

    <div class="form-row">
        <table class="frame-preview">
            <tr>
                <td class="const">AA</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="data"></td>
                <td class="const"></td>
                <td class="const">A5</td>
            </tr>
        </table>
        
    </div>

</script>

<script type="text/x-red" data-help-name="custom-output">
    <p>Allows controlling any of the Hapcan and Hapcan's compatible modules.</p>
    <p>The node allows you to send custom message to any device. It uses the Ethernet gateway to communicate with Hapcan bus.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | number | bool | any | object</span></dt>
        <dd>Any input message will perform default action. If topic is set to <i>control</i> the payload will control the Relay module.</dd>

        <dt class="optional">topic <span class="property-type">string</span></dt>
        <dd>Topic is optional. When a <i>control</i> value is provided it will overrides default action settings and allows controlling of the node directly.</dd>
    </dl>
    
    <h3>Details</h3>
    <p>The default node behaviour on any input message is to execute the action specified in properties. 
        When <code>msg.topic</code> is set to <i>control</i> then input value will control node in several ways. In control mode the <code>msg.payload</code> 
        can be one of the following types:
    </p>
    <dl class="message-properties">
        <dt>string</dt> 
        <dd>Value of <i>on</i>, <i>off</i> or <i>toggle</i> will control the default channel. Other strings are ignored. Case insensitive.</dd>

        <dt>number</dt> 
        <dd>Hapcan's Relay module instruction. 0(off), 1(on) or 2(toggle) will control the default channel. Other values are ignored.</dd>            

        <dt>boolean</dt> 
        <dd>Output will turn ON when value is true, otherwise it will turn OFF. This type is easy to use with UI switch control.</dd>

        <dt>object</dt> 
        <dd>Gives an ability to override node default parameters. See details below.</dd>
        
    </dl>
    <h3>Full control object definition</h3>
    <p>
        Passing the <i>object</i> (JSON) in <code>msg.payload</code> allows to control Relay module. Below are the possible properties list that can be specified. 
        If no property is specified the default node settings values will be used. Node will throw an error in case of invalid values.
    </p>
    <dl class="message-properties">
        <dt>channels <span class="property-type">number | array</span></dt> 
        <dd>Single number value or number array of selected channels to perform the action.</dd>

        <dt>action <span class="property-type">string | number | bool</span></dt></dt> 
        <dd>String or number action representation. See <code>msg.payload</code> description above for details.</dd>

        <!-- <dt>delay <span class="property-type">string | number</span></dt></dt> 
        <dd>Delay value as a string or Hapcan delay value.</dd> -->
    </dl>
    
    <p>Default module version is UNIV-3. You can select UNIV-1 support in settings.</p>
    
    <h3>References</h3>
    <ul>
        <li><a href="http://hapcan.com/devices/universal/univ_3/univ_3-2-x-x.htm">Hapcan relays UNIV-3</a> - module firmware notes.</li>
        <li><a href="http://hapcan.com/devices/universal/univ_v1-0/univ_v1-0-2-0/index.htm">Hapcan relays UNIV-1</a> - firmware notes.</li>
    </ul>

</script>



<script type="text/javascript">
    RED.nodes.registerType('custom-input',{
        category: 'hapcan',
        color: '#D3D3D3',
        defaults: {
            gateway: {type:"hapcan-gateway", required: true},
            name: {value:""},
            group: {value: 1, required: true, validate: function(val){return (val > 0 && val < 256);} },
            node: {value: 1, required: true, validate: function(val){return (val > 0 && val < 256);}},
            frameTypeFilter: {value: '', validate: function(val){
                if(val === '') return true; 
                var type = Number(val); 
                if(!Number.isInteger(type)) 
                    return false; 
                if(type<0 || type > 999) 
                    return false; 
                return true; 
            }},
            d0name: {value:''},
            d1name: {value:''},
            d2name: {value:''},
            d3name: {value:''},
            d4name: {value:''},
            d5name: {value:''},
            d6name: {value:''},
            d7name: {value:''},
        },
        inputs:0,
        outputs:1,
        icon: "relay-output.png",
        align: 'left',
        label: function() {
            let filter = ''
            if( this.frameTypeFilter > 0 )
                filter = ` [0x${this.frameTypeFilter}]`;

            return (this.name||"custom input") + ' ('+this.node+','+this.group+')' + filter;
        },
        labelStyle: function() { return this.name?"node_label_italic":""; } ,
        oneditprepare: function() {

            var nodeOptions = '';
            var groupOptions = '';
            for(var i = 1; i < 256; i++)
            {
                var selectedNode = '';
                if((Number(this.node) === i))
                    selectedNode = 'selected="selected"';
                nodeOptions += '<option '+ selectedNode +' value="'+i+'">'+i+'</option>';

                var selectedGroup = '';
                if((Number(this.group) === i))
                    selectedGroup = 'selected="selected"';
                
                groupOptions += '<option '+ selectedGroup +' value="'+i+'">'+i+'</option>';
            }
            
            $("#node-input-node").append(nodeOptions);
            $("#node-input-group").append(groupOptions);
        },
        oneditsave: function(){
        }
        });

</script>

<script type="text/x-red" data-template-name="custom-input">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Device name">
    </div>
    <div class="form-row">
        <label for="node-input-gateway"><i class="fa fa-globe"></i> Gateway</label>
        <input type="text" id="node-input-gateway" placeholder="Gateway">
    </div>
    <div class="form-row">
        <label for="node-input-node"><i class="fa fa-microchip"></i> Node</label>
        <select id="node-input-node"></select>
    </div>
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-th"></i> Group</label>
        <select id="node-input-group"></select>
    </div>

    <div class="form-row">
        <label for="node-input-frameTypeFilter"><i class="fa fa-sign-out"></i> Frame filter</label>
        <input type="text" id="node-input-frameTypeFilter" placeholder="Leave empty to receive all types">
    </div>
    <hr>

    <div class="form-row">
        <label for="node-input-d0name"><i class="fa fa-cube"></i> D0 name</label>
        <input type="text" id="node-input-d0name" placeholder="Data byte 0 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d1name"><i class="fa fa-cube"></i> D1 name</label>
            <input type="text" id="node-input-d1name" placeholder="Data byte 1 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d2name"><i class="fa fa-cube"></i> D2 name</label>
            <input type="text" id="node-input-d2name" placeholder="Data byte 2 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d3name"><i class="fa fa-cube"></i> D3 name</label>
            <input type="text" id="node-input-d3name" placeholder="Data byte 3 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d4name"><i class="fa fa-cube"></i> D4 name</label>
            <input type="text" id="node-input-d4name" placeholder="Data byte 4 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d5name"><i class="fa fa-cube"></i> D5 name</label>
            <input type="text" id="node-input-d5name" placeholder="Data byte 5 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d6name"><i class="fa fa-cube"></i> D6 name</label>
            <input type="text" id="node-input-d6name" placeholder="Data byte 6 property name">
    </div>
    <div class="form-row">
            <label for="node-input-d7name"><i class="fa fa-cube"></i> D7 name</label>
            <input type="text" id="node-input-d7name" placeholder="Data byte 7 property name">
    </div>
    
    
    <!-- <div class="form-row">
        <label style="width: auto;"><i class="fa fa-envelope-o"></i> Set <b>userField</b> value for states:</label>
    </div>
    <div class="form-row">
        <label style="padding-left: 25px; margin-right: -25px;" for="node-input-userFieldStateON"><i class="fa fa-circle"></i> ON</label>
        <input type="text" id="node-input-userFieldStateON" >
    </div>
    <div class="form-row">
        <label style="padding-left: 25px; margin-right: -25px;" for="node-input-userFieldStateOFF"><i class="fa fa-circle"></i> OFF</label>
        <input type="text" id="node-input-userFieldStateOFF" >
    </div> -->
  
</script>

<script type="text/x-red" data-help-name="custom-input">
    <p>Receives any Hapcan messages.</p>
    <p>The node emit all messages received from device. It uses the Ethernet gateway to receive messages from Hapcan bus.</p>
    
    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Hapcan message object with relay module's state data.</dd>
    </dl>
    
    <h3>Details</h3>
    <p>The <code>msg.payload</code> contains:
    </p>
    <dl class="message-properties">
        <dt>frame <span class="property-type">Buffer[15]</span></dt>
        <dd>15 bytes buffer containing raw Hapcan's CAN frame.</dd>

        <dt>frameType <span class="property-type">number</span></dt>
        <dd>Hapcan frame type number</dd>

        <dt>isAnswer <span class="property-type">bool</span></dt>
        <dd><i>True</i> if message is an answer for request.</dd>
        
        <dt>node <span class="property-type">number</span></dt>
        <dd>Sender module node number.</dd>

        <dt>group <span class="property-type">number</span></dt>
        <dd>Sender module group number.</dd>
        
        <dt>frame filter <span class="property-type">empty | number</span></dt>
        <dd>If filter is specified (3-digit frame type) the node will emit message only if received hapcan message match filter value. 
            Leave empty to emit all the received messages.
        </dd>

        <dt>D[0-7] name <span class="property-type">empty | string</span></dt>
        <dd>You can specify a message property name for each 8 data bytes of the received hapcan message. If You provide name for data byte the emitted message
            will contain this property with value of the corresponding data byte.
        </dd>        

    </dl>
    <p>
        This node receives all messages of the selected module in group.
    </p>
</script>