<script type="text/javascript">
    RED.nodes.registerType('hapcan-gateway',{
        category: 'config',
        // color: '#E9967A',
        defaults: {
            host: {value:"192.168.0.100", required: true, },
            port: {value: 1000, required: true, validate: function(val){return (val>0 && val < 65535);}},
            group: {value: 1, required: true, validate: function(val){return (val > 0 && val < 256);}},
            node: {value: 1, required: true, validate: function(val){return (val > 0 && val < 256);}},
            debugmode: {value: false},
            reconnectPeriod: {value: 1000, validate: function(val){ return !val || val > 0; } },
            devices: {value: []}
        },
        label: function() {
            return this.host+':'+this.port + ' ('+this.node+','+this.group+')';
        },
        discoveringTimer: null,
        cleanUp: null,
        showDevices: null,
        oneditprepare: function(){
            let config = this
            var discovering = false

            if(this.debugmode)
                $("#node-input-debugmode").prop('checked', true);
            $('#node-config-input-reconnectPeriod').val(this.reconnectPeriod || 1000);
            
            cleanUp = function() {
                if( discovering )
                    $('#discover-devices').trigger('click')
                $('#discover-devices').off('click')
                $('#clear-devices').off('click')
                $(`#hapcan-devices table .caret`).off('click')
            }

            showDevices = function(){
                config.devices.forEach(device => {
                    
                    var channelsRowContent = ''
                    if(device.channels === undefined)
                        device.channels = []
                    for(let i = 0; i < device.channels.length; i++)
                    {
                        channelsRowContent += `<li id="hapcan-device-${device.id}-channel-${i}">#${i+1} ${device.channels[i].name}</li>`
                    }

                    var row = `<td><span class="caret"> <i class="fa ${device.applicationTypeIcon}"></i> ${device.description} (${device.node}, ${device.group})</span>
                                <ul class="nested">${channelsRowContent}</ul>
                                </td>
                                <td>${device.hardwareVersion}.${device.applicationType}.${device.applicationVersion}.${device.firmwareVersion} ${device.applicationTypeString}</td>
                                <td>${device.hardwareTypeString}</td>`


                    var tableRow = $(`#hapcan-devices table #hapcan-device-${device.id}`)

                    if(tableRow.length)
                    {
                        tableRow.children('.caret').off('click')
                        tableRow.html(row)
                    }
                    else
                    {
                        $("#hapcan-devices table tr:last").after(`<tr id="hapcan-device-${device.id}">${row}</tr>`)
                    }

                    tableRow = $(`#hapcan-devices table #hapcan-device-${device.id} .caret`)
                    tableRow.on('click', onCaretClick)

                })
            }
            
            onCaretClick = function(evt)
            {
                $(evt.currentTarget).parent().children('.nested').toggleClass('active')
                $(evt.currentTarget).toggleClass('caret-down')
            }

            $('#discover-devices').click(async function(){
                discovering = !discovering
                if(discovering)
                {
                    $('#hapcan-devices table tr:not(:first-child)').addClass('hapcan-device-need-refresh').removeClass('hapcan-device-not-found')

                    $(this).html('<i class="fa fa-refresh fa-spin"></i> Updating device list... (click to stop)')
                    
                    for(let i = 1; i < 255; i++){
                        $('#hapcan-discover-progressbar div').css('width', parseInt(((i+1)/255)*100)+'%' )
                        await $.getJSON(`hapcan-devices-discover/${config.id}/${i}`,function(data) {
                            var devicesInGroup = JSON.parse(data)
                            devicesInGroup.forEach(foundDevice => {
                                var device = config.devices.find( v => v.id === foundDevice.id )
                                if(device === undefined)
                                {
                                    config.devices.push(foundDevice)
                                }
                                else
                                {
                                    $(`#hapcan-devices table #hapcan-device-${device.id}`).removeClass('hapcan-device-need-refresh')
                                    if(foundDevice.description !== '') 
                                        device.description = foundDevice.description
                                    if(foundDevice.serialNumber !== 0)
                                        device.serialNumber = foundDevice.serialNumber;
                                    if(foundDevice.hardwareType !== 0)
                                        device.hardwareType = foundDevice.hardwareType
                                    if(foundDevice.hardwareTypeString !== 'unknown')  
                                        device.hardwareTypeString = foundDevice.hardwareTypeString
                                    if(foundDevice.hardwareVersion !== 0)  
                                        device.hardwareVersion = foundDevice.hardwareVersion
                                    if(foundDevice.applicationType !== 0)  
                                        device.applicationType = foundDevice.applicationType
                                    if(foundDevice.applicationTypeString !== 'unknown')
                                        device.applicationTypeString = foundDevice.applicationTypeString
                                    if(foundDevice.applicationTypeIcon !== 'fa-microchip')  
                                        device.applicationTypeIcon = foundDevice.applicationTypeIcon
                                    if(foundDevice.applicationVersion !== 0)  
                                        device.applicationVersion = foundDevice.applicationVersion
                                    if(foundDevice.firmwareVersion !== 0)  
                                        device.firmwareVersion = foundDevice.firmwareVersion
                                    
                                    device.channels = [...foundDevice.channels]
                                }
                                
                            })
                            showDevices()
                        })
                        if(!discovering)
                            return                            
                    }
                    $('#discover-devices').trigger('click')
                }
                else
                {
                    $(this).html('<i class="fa fa-refresh"></i> Discover/Refresh devices')
                }
                
                $('#hapcan-devices table tr:not(:first-child)')
                    .filter(function(){return $(this).hasClass('hapcan-device-need-refresh')})
                        .addClass('hapcan-device-not-found')
                        .removeClass('hapcan-device-need-refresh')
            })

            $('#clear-devices').click(async function()
            {
                config.devices = [];
                $(`#hapcan-devices table .caret`).off('click', onCaretClick)
                $('#hapcan-devices table tr:not(:first-child)').remove()
                $('#hapcan-discover-progressbar div').css('width', '0%' )
            })

            showDevices()
        },
        oneditsave: function(){
            this.debugmode = $("#node-input-debugmode").is(":checked") ? true : false;
            cleanUp()
        },
        oneditcancel: function(){
            cleanUp()
        },
        oneditdelete: function(){
            cleanUp()
        }

        });
</script>

<script type="text/x-red" data-template-name="hapcan-gateway">
    <div class="form-row">
        <label for="node-config-input-host"><i class="icon-bookmark"></i> Host</label>
        <input type="text" id="node-config-input-host" placeholder="Hapcan ethernet module ip">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="icon-bookmark"></i> Port</label>
        <input type="number" id="node-config-input-port" placeholder="Hapcan ethernet module port number">
    </div>    
    <div class="form-row">
        <label for="node-config-input-node"><i class="fa fa-microchip"></i> Node</label>
        <input type="number" id="node-config-input-node" placeholder="Node number (1-255)">
    </div>
    <div class="form-row">
        <label for="node-config-input-group"><i class="fa fa-th"></i> Group</label>
        <input type="number" id="node-config-input-group" placeholder="Group number (1-255)">
    </div>
    <div class="form-row">
        <label for="node-config-input-reconnectPeriod"><i class="fa fa-refresh"></i> Reconnect period [ms]</label>
        <input type="number" id="node-config-input-reconnectPeriod" placeholder="1000">
    </div>

    
    <div class="form-row">
        <label for="node-input-debugmode"><i class="fa fa-bug"></i> Debug mode</label>
        <input style="width: 5%;" id="node-input-debugmode" type="checkbox" ><br>
        <span style="opacity: 0.7; font-size: 12px;">Enable Hapcan message loging into console.</span>
    </div>

    <style>
            #hapcan-devices table {
                width: 98%;
                font-size: 12px;
                text-align: left;
            }
            #hapcan-devices table td{
                padding-right: 16px;
                vertical-align: top;
            }
            #hapcan-devices table tr:hover td{
                background-color: #eee;
            }
    
            #hapcan-discover-progressbar {
                height: 5px;
                background-color: #eee;
            }

            #hapcan-discover-progressbar div {
                background-color: rgb(85, 170, 136);
                height: 100%;
                width: 0%;
                transition: width 0.3s;
            }

            #clear-devices {
                right: 16px;
                position: absolute;
            }

            .hapcan-device-not-found {
                color: red;
            }
            .hapcan-device-need-refresh {
                opacity: 0.6;
            }

            #hapcan-devices .caret {
                cursor: pointer;
                user-select: none;
            }

            #hapcan-devices ul {
                list-style-type: none;
            }
              
            #hapcan-devices .caret::before {
                content: "\25B6";
                color: black;
                display: inline-block;
                margin-right: 6px;
                transition: all 0.3s;
            
            }
              
            #hapcan-devices .caret-down::before {
                transform: rotate(90deg);
            }

            #hapcan-devices .nested {
                display: none;
            }
            
            #hapcan-devices .active {
                display: block;
            }

        </style>

    <div class="form-row">
        <button id="discover-devices"><i class="fa fa-refresh"></i> Discover/Refresh devices</button>
        <button id="clear-devices"><i class="fa fa-trash"></i> Clear device list</button>
    </div>
    <div class="form-row" id="hapcan-discover-progressbar">
        <div></div>
    </div>    

    <div class="form-row" id="hapcan-devices">
        <table>
            <tr>
                <th style="width: auto;">Description (Node, Group)</th>
                <th style="width: 140px;">Firmware</th>
                <th style="width: 90px;">Hardware</th>
            </tr>
        </table>
    </div>

</script>

<script type="text/x-red" data-help-name="hapcan-gateway">
    <p>Hapcan configuration and gateway node.</p>
    
    <h3>Overview</h3>
    <p>This node is used by each functional node to communicate with Hapcan bus via Ethernet interface.</p>

    <h3>Configuration</h3>
    <p>Specify <b>host</b> and <b>port</b> of Hapcan ethernet interface.</p>
    <p><b>Reconnect period</b> will be used when node lose connection. After this period of time the node will 
        try to connect to the Ethernet module again.
    </p>
    <p><b>Debug mode</b> will displat each send and received Hapcan frame in the system console (when Node-red is running as a console application)</p>
    <p><b>Discover/Refresh devices</b> button will fire a device searching procedure (from group 1 to 255). The found devices will
        be shown in the table view below. Each time the button is pressed, the device list is being updated (data is changed) and
        populate with new devices found. Devices list is stored in the configuration node and will be used
        in other nodes to choose Hapcan device easily. You don't have to refresh devices, but then You should
        know node and group number of the device You want to use in Node-red.
    </p>
    <p>Any time You add, remove or change any module configuration in Hapcan network, use Discover/Refresh function to update 
        the devices list.
    </p>
</script>